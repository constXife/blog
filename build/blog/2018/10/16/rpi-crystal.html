<!doctype html> <!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang=""><![endif]--> <!--[if IE 7]><html class="no-js lt-ie9 lt-ie8" lang=""><![endif]--> <!--[if IE 8]><html class="no-js lt-ie9" lang=""><![endif]--> <!--[if gt IE 8]><!--> <html class=no-js lang=""> <!--<![endif]--> <head> <meta charset=utf-8> <meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"> <title>Блог Тыща constXife Кьятлоттьяви - Crystal 0.26 на Raspberry PI (raspbian)</title> <meta name=description content=""> <meta name=viewport content="width=device-width, initial-scale=1"> <link rel=stylesheet href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.4/css/bootstrap.min.css" integrity="2hfp1SzUoho7/TsGGGDaFdsuuDL0LX2hnUp6VkX3CUQ2K4K+xjboZdsXyp4oUHZj" crossorigin=anonymous> <link rel=stylesheet href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css"> <link href="../../../../stylesheets/layout.css" rel=stylesheet /> <!--[if lt IE 9]><script src="js/vendor/html5-3.6-respond-1.4.2.min.js"></script><![endif]--> <link rel=alternate type="application/atom+xml" title="Atom Feed" href="/blog/feed.xml"/> </head> <body> <!--[if lt IE 8]><p class=browserupgrade>You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p><![endif]--> <header class=container-fluid> <div id=scene_text class=flex-items-xs-middle> <div class=lead> <a href="/">constXife</a> <p>Обжигающе-холодные, мерцающие угольки</p> </div> <div class=contacts> <div class="ul list-inline"> <li class=list-inline-item> <a href="mailto:constxife@yandex.ru" title="Связаться через e-mail"> <i class="fa fa-envelope"></i> </a> </li> <li class=list-inline-item> <a href="https://github.com/constXife" title=GitHub> <i class="fa fa-github"></i> </a> </li> </div> </div> </div> </header> <div class="main wrapper clearfix"> <div class="col-md-1 col-lg-1"></div> <div id=main role=main class="col-xs-12 col-sm-12 col-md-10 col-lg-10"> <article> <div class=head> <div class=category> <i class="fa fa-magic"></i> Разработка </div> <h2>Crystal 0.26 на Raspberry PI (raspbian)</h2> <hr> <div class=meta>Опубликовано 16 октября, 2018</div> </div> <div class=body> <hr/> <p>Установка <a href="http://crystal-lang.org">Crystal 0.26</a> на Raspberry PI (raspbian).</p> <p>Решил я на выходных поиграться с Arduino и построением веб-интерфейса к моим механизмам на платформе Rasberry PI. Можно было бы наклепать сайтик на Ruby и не писать эту статью, но <a href="#reason">по определенным причинам</a>, я решил делать веб-сайт на Crystal — компилируемым ruby-like языке. Засучил рукава, открыл гугл и наткнулся на отличный ответ на <a href="https://stackoverflow.com/questions/42796143/how-do-i-install-crystal-lang-on-rapsberry-pi">stackoverflow</a>, который мне здорово помог в моих изысканиях. Можно было бы удовлетвориться semi-официальному зеркалу Crystal и успокоиться, благо он встал в RPi словно всегда там и стоял. Но так как в репозитории была старая версия, то <a href="#reason">по определенным причинам</a>, я решил пользоваться современнейшими технологиями и быть на острие прогресса, поэтому передо мной встала задача внедрить новейший Crystal в этот миниатюрно-мигающий, процессинговый оплот моих будущих экспериментов. Итоги моих мытарств я сейчас и изложу в кратком виде.</p> <p>В нашем распоряжении</p> <ul> <li>Компьютер с Debian GNU/Linux 9 (stretch), llvm-3.8</li> <li>Raspberry Pi Zero, Raspbian GNU/Linux 9 (stretch), llvm-3.8</li> <li>Решимость во что бы то ни стало пройти сквозь тернии к установленному Crystal-у</li> </ul> <p>Общая схема действий такова: мы на нашем Debian скомпилируем object файл, перенесём его на raspbian, скомпилируем его там и наслаждаемся результатом. Самая главная мысль, которая проходит сквозь весь туториал — надо держать версии софта на обоих системах одинаковыми. Я кучу времени убил, пытаясь установить более новое ПО то тут, то там, но в итоге оставил софт, который уже был в пакетах.</p> <p>Сначала <a href="https://crystal-lang.org/docs/installation/on_debian_and_ubuntu.html">установим</a> на наш Debian Crystal нужной версии. Далее нужно провести предварительные ласки для Debian и для raspbian в виде установки обязательного программного обеспечения, общий список которых находится — <a href="https://github.com/crystal-lang/crystal/wiki/All-required-libraries">тут</a>.</p> <p>Принимаем во внимание, что нам не нужно ставить BOEHM GC из исходников, у нас этим занимается пакет <em>libgc-dev</em>, который нужно поставить, если его нет.</p> <h5 id=debian>Debian</h5> <ul> <li>Клонируем исходники crystal</li> </ul> <p><code> user@debian ~/src $ git clone https://github.com/crystal-lang/crystal </code></p> <p><code> user@debian ~/src $ cd crystal </code></p> <ul> <li>Переключаемся из мастера в стабильную ветку</li> </ul> <p><code> user@debian ~/src/crystal $ git checkout 0.26.1 </code></p> <ul> <li>Собираем объектный файл компилятора</li> </ul> <p><code> user@debian ~/src/crystal $ make deps </code></p> <p><code> user@debian ~/src/crystal $ ./bin/crystal build src/compiler/crystal.cr --cross-compile --target "armv6-unknown-linux-gnueabihf" --release -s -D without_openssl -D without_zlib </code></p> <p>Если всё сделано правильно, то у нас в директории появится файл <em>crystal.o</em>. Половина дела сделана. Переходим к raspbian.</p> <h5 id=raspbian>Raspbian</h5> <ul> <li>Повторяем действия как на debian</li> </ul> <p><code> user@raspbian ~/src $ git clone https://github.com/crystal-lang/crystal </code></p> <p><code> user@raspbian ~/src $ cd crystal </code></p> <p><code> user@raspbian ~/src/crystal $ git checkout 0.26.1 </code></p> <p><code> user@raspbian ~/src/crystal $ make deps </code></p> <ul> <li>Бережно переносим файл <em>crystal.o</em> на raspbian с debian.</li> </ul> <p><code> user@raspbian ~/src/crystal $ scp user@debian:~/src/crystal/crystal.o . </code></p> <ul> <li>Я решил взять расположение файлов как в Debian, чтобы было удобнее пользоваться компилятором (это обусловлено динамической линковкой компилятора — ему потребуется доступ к библиотекам и исходникам)</li> </ul> <p><code> user@raspbian ~/src/crystal $ mkdir -p /usr/share/crystal /usr/lib/crystal/bin </code></p> <p><code> user@raspbian ~/src/crystal $ cp -R src /usr/share/crystal/src </code></p> <ul> <li>Компилируем! (обратите внимание, что строка линковки отличается от предлагаемой после создания crystal.o, потому что у нас несколько другое расположение папок и файлов)</li> </ul> <p><code> user@raspbian ~/src/crystal $ cc 'crystal.o' -o '/usr/lib/crystal/bin/crystal' -rdynamic /usr/share/crystal/src/llvm/ext/llvm_ext.o `/usr/bin/llvm-config-3.8 --libs --system-libs --ldflags 2&gt; /dev/null` -lstdc++ -lpcre -lm -lgc -lpthread /usr/share/crystal/src/ext/libcrystal.a -levent -lrt -ldl -L/usr/lib -L/usr/local/lib </code></p> <p>В идеале здесь у вас должен скомпилироваться компилятор, если нет, проверьте шаги ранее, а может я просто ошибся в последовательности действий или забыл что-то очень важное. Но, предположим, что всё идёт по плану. Дальше нужно дать доступ другим пользователям до бинарника и добавить shards (bundler в кристальном мире).</p> <ul> <li>Забираем shell-обвязку к компилятору c Debian (из-за динамической линковки компилятора)</li> </ul> <p><code> user@raspbian ~/src/crystal $ scp user@debian:/usr/bin/crystal /usr/bin/crystal </code></p> <p><code> user@raspbian ~/src/crystal $ cd .. </code></p> <p><code> user@raspbian ~/src $ git clone https://github.com/crystal-lang/shards.git </code></p> <p><code> user@raspbian ~/src $ cd shards </code></p> <p><code> user@raspbian ~/src/shards $ git checkout v0.8.1 </code></p> <p><code> user@raspbian ~/src/shards $ crystal build src/shards.cr -o /usr/lib/crystal/bin/shards --release </code></p> <p><code> user@raspbian ~/src/shards $ ln -s /usr/lib/crystal/bin/shards /usr/bin </code></p> <p>Вуаля.</p> <p><code> user@raspbian ~/src/shards $ crystal -v </code></p> <p><code> user@raspbian ~/src/shards $ shards --version </code></p> <h5 id=section>Сноски</h5> <p id=reason>* так как я люблю создавать себе проблемы на пустом месте</p> </div> </article> </div> <div class="col-md-1 col-lg-1"></div> </div> <div id=footer class=container-fluid> <footer class=wrapper> &copy; 2013 </footer> </div> <script src="../../../../javascripts/site.js"></script> <script>
    (function (d, w, c) {
        (w[c] = w[c] || []).push(function() {
            try {
                w.yaCounter21799057 = new Ya.Metrika({
                    id:21799057,
                    clickmap:true,
                    trackLinks:true,
                    accurateTrackBounce:true
                });
            } catch(e) { }
        });

        var n = d.getElementsByTagName("script")[0],
            s = d.createElement("script"),
            f = function () { n.parentNode.insertBefore(s, n); };
        s.type = "text/javascript";
        s.async = true;
        s.src = "https://mc.yandex.ru/metrika/watch.js";

        if (w.opera == "[object Opera]") {
            d.addEventListener("DOMContentLoaded", f, false);
        } else { f(); }
    })(document, window, "yandex_metrika_callbacks");
</script> <noscript><div><img src="https://mc.yandex.ru/watch/21799057" style="position:absolute; left:-9999px;" alt=""/></div></noscript> </body> </html>